<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clientes y Cobros</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Clientes y Cobros</h1>

  <h3>Clientes</h3>
  <div class="row">
    <input id="searchBox" placeholder="Buscar cliente...">
    <button id="btnAddClient">‚ûï A√±adir cliente</button>
  </div>
  <table id="tblClients"></table>

  <h3>Registro de nuevo cobro</h3>
  <form id="formInvoice" class="row">
    <select id="invClient"></select>
    <input id="invDate" type="date">
    <input id="invTime" type="time">
    <input id="invAmount" type="number" step="0.01" placeholder="$">
    <input id="invTech" placeholder="T√©cnica">
    <textarea id="invNotes" placeholder="Notas (opcional)"></textarea>
    <button type="submit">üíæ Guardar</button>
  </form>

  <h3>Historial de cobros</h3>
  <div class="row">
    <button class="btn small" id="btnExportInvPDF">üñ®Ô∏è PDF</button>
    <button class="btn small" id="btnExportInvJSON">üíæ JSON</button>
    <button class="btn small" id="btnExportInvCSV">üìÑ CSV</button>
    <input type="file" id="importInvJSON" class="no-print" accept="application/json">
  </div>
  <div class="row" style="margin-top:.5rem">
    <input type="date" id="filterInvDate" placeholder="Fecha">
    <input type="time" id="filterInvHour" placeholder="Hora">
    <select id="filterInvTech">
      <option value="">Todas las t√©cnicas</option>
    </select>
  </div>
  <table id="tblInv"></table>

  <script>
    const state = { clients: [], invoices: [] };

    function renderClients() {
      const search = document.getElementById("searchBox").value.toLowerCase();
      const filtered = state.clients.filter(c => c.name.toLowerCase().includes(search));
      document.getElementById("tblClients").innerHTML = filtered.map(c =>
        `<tr><td>${c.name}</td><td>${c.email}</td></tr>`
      ).join('');
    }

    function renderBilling() {
      const dateF = document.getElementById('filterInvDate')?.value;
      const hourF = document.getElementById('filterInvHour')?.value;
      const techF = document.getElementById('filterInvTech')?.value;
      let filtered = state.invoices;

      if(dateF) filtered = filtered.filter(i => i.date === dateF);
      if(hourF) filtered = filtered.filter(i => i.time?.startsWith(hourF));
      if(techF) filtered = filtered.filter(i => i.tech === techF);

      const techSel = document.getElementById('filterInvTech');
      if(techSel && techSel.children.length <= 1){
        const opts = Array.from(new Set(state.invoices.map(i=>i.tech).filter(Boolean)));
        opts.forEach(t => {
          const o = document.createElement('option');
          o.value = t;
          o.textContent = t;
          techSel.appendChild(o);
        });
      }

      const tbl = document.getElementById('tblInv');
      tbl.innerHTML = filtered.map(i =>
        `<tr><td>${i.client}</td><td>${i.date}</td><td>${i.time}</td><td>${i.amount}</td><td>${i.tech}</td><td>${i.notes || ''}</td></tr>`
      ).join('');

      document.getElementById('btnExportInvPDF').onclick = () => exportPDF(filtered);
      document.getElementById('btnExportInvCSV').onclick = () => exportCSV(filtered);
      document.getElementById('btnExportInvJSON').onclick = () => exportJSON(filtered);

      document.getElementById('filterInvDate').oninput = renderBilling;
      document.getElementById('filterInvHour').oninput = renderBilling;
      document.getElementById('filterInvTech').oninput = renderBilling;
    }

    function exportCSV(data) {
      const headers = ['Cliente','Fecha','Hora','Monto','T√©cnica','Notas'];
      const rows = data.map(i => [i.client, i.date, i.time, i.amount, i.tech, i.notes || '']);
      const csv = [headers, ...rows].map(r => r.join(',')).join('\\n');
      downloadFile(csv, 'historial.csv', 'text/csv');
    }

    function exportJSON(data) {
      const json = JSON.stringify(data, null, 2);
      downloadFile(json, 'historial.json', 'application/json');
    }

    function exportPDF(data) {
      let contenido = 'Cliente\tFecha\tHora\tMonto\tT√©cnica\tNotas\\n';
      data.forEach(i => {
        contenido += `${i.client}\\t${i.date}\\t${i.time}\\t${i.amount}\\t${i.tech}\\t${i.notes || ''}\\n`;
      });
      downloadFile(contenido, 'historial.pdf.txt', 'application/pdf'); // Simulado como texto
    }

    function downloadFile(content, filename, type) {
      const blob = new Blob([content], { type });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
    }

    document.getElementById("btnAddClient").onclick = () => {
      const name = prompt("Nombre del cliente:");
      const email = prompt("Correo electr√≥nico:");
      if(name) {
        state.clients.push({ name, email });
        renderClients();
      }
    };

    document.getElementById("formInvoice").onsubmit = (e) => {
      e.preventDefault();
      const invoice = {
        client: document.getElementById("invClient").value,
        date: document.getElementById("invDate").value,
        time: document.getElementById("invTime").value,
        amount: document.getElementById("invAmount").value,
        tech: document.getElementById("invTech").value,
        notes: document.getElementById("invNotes").value,
      };
      state.invoices.push(invoice);
      renderBilling();
    };

    renderClients();
    renderBilling();
  </script>
</body>
</html>
